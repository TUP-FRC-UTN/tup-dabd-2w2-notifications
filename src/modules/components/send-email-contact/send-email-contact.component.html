<div class="card mt-5">
    <div class="card-body">
        <h1> Notificaciones a varios Contactos </h1> <br>
        <form #form="ngForm" (submit)="submit()">
            <!---->


<!-- Botón para abrir el modal -->
<button type="button" class="btn btn-secondary mt-3" (click)="openContactSelectionModal()">Seleccionar contactos</button>

<!-- Mostrar contactos seleccionados -->
<div *ngIf="selectedContacts.length > 0" class="selected-contacts mt-3">
  <h6>Contactos seleccionados:</h6>
  <ul>
    <li *ngFor="let contact of selectedContacts">
      {{ contact.contactValue }}
    </li>
  </ul>
</div>

<!-- Modal de selección de contactos -->
<div class="modal" *ngIf="showContactModal" (click)="closeContactSelectionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closeContactSelectionModal()">&times;</span>
    <h5>Selecciona los contactos:</h5>

    <!-- Tabla de contactos con checkboxes -->
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Seleccionar</th>
          <th scope="col">Contacto</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let contact of allContacts; trackBy: trackByContactId">
          <td>
            <input type="checkbox" 
                   [checked]="contacts_id.includes(contact.id)"
                   (change)="toggleContactSelection(contact.id)">
          </td>
          <td>{{ contact.contactValue }}</td>
        </tr>
      </tbody>
    </table>

    <!-- Botón de confirmación para cerrar el modal y guardar los cambios -->
    <div class="text-end">
      <button type="button" class="btn btn-primary" (click)="confirmContactSelection()">Confirmar selección</button>
    </div>
  </div>
</div>

           
              


            <!---->
            <label class="form-label mt-3">Asunto:</label>
            <input #asunto="ngModel" name="subject" type="text" class="form-control mb-3" style="max-width: 350px;" [(ngModel)]="subjectToSend"
            required minlength="3"
                [ngClass]="{'is-invalid' : asunto.invalid && (asunto.dirty || asunto.touched), 'is-valid' : asunto.valid}"/>
                @if (asunto.invalid && (asunto.dirty || asunto.touched)) {
                    @if (asunto.getError('minlength')) {
                        <div class="text-danger"> Debe contener mínimo tres caracteres </div>
                    }@else {
                        <div class="text-danger"> Campo Obligatorio </div>
                    }
                }
            <!--
            <h6 class="mt-3">Variables</h6>
            <div class="mb-3">
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" style="max-width: 200px;"
                        [(ngModel)]="variableName"/>
                        <label class="form-label">Valor:</label>
                        <input type="text" class="form-control" id="valor" name="valor" style="max-width: 200px;"
                        [(ngModel)]="variableValue"/>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-secondary mb-3" (click)="addVariables()">+</button>
                        <br>
                        <h6>Tus Variables:</h6>
                        @for (item of variables; track $index) {
                            <p>Nombre: {{item.key}} Valor: {{item.value}}</p>
                        }
                    </div>
                </div>
            </div>
            -->
            <h6>Plantillas</h6>
                <select #plantillas="ngModel" class="form-select" style="max-width: 200px;" name="plantillas" id="plantillas"
                [(ngModel)]="template_id"
                required
                [ngClass]="{'is-invalid': plantillas.invalid && (plantillas.dirty || plantillas.touched), 'is-valid': plantillas.valid && (plantillas.dirty || plantillas.touched)}">

                @for (item of allTemplates; track $index) {
                    <option [value]=item.id> {{item.name}} </option>
                }
                </select>
                @if (plantillas.invalid && (plantillas.dirty || plantillas.touched)) {
                    @if (plantillas.getError('required')) {
                        <div class="text-danger"> Campo Obligatorio </div>
                    }
                }
            <button type="button" class="btn btn-secondary mt-3" (click)="previewSelectedTemplate()">Previsualizar</button>
            <!-- Si encuentran otra forma de hacerlo, haganlo-->
            <div class="row">
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"></div>
                <div class="col-1"><button type="submit" class="btn btn-primary" [disabled]="form.invalid">Enviar</button></div>
            </div>
        </form>
    </div>
    
</div>


<!-- Modal de previsualización -->
<div class="modal" *ngIf="showModalToRenderHTML" (click)="closeModalToRenderHTML()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <span class="close" (click)="closeModalToRenderHTML()">&times;</span>
        <iframe #iframePreview style="width: 100%; border: none;"></iframe>
        <div class="mt-3 text-end">
          <button type="button" class="btn btn-secondary" (click)="closeModalToRenderHTML()">Aceptar</button>
        </div>
    </div>
  </div>
